<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Top Destinations — GoNepal</title>
  <meta name="description" content="Top destinations in Nepal: Kathmandu Valley, Pokhara, Chitwan and Lumbini — maps, hotels, weather and directions." />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    /* Theme vars (kept consistent with home page) */
    :root{
      --primary:#004d98;
      --primary-700:#00386e;
      --accent:#ffcc33;
      --muted:#6b7280;
      --bg: linear-gradient(180deg,#eef6ff 0%,#f3f8ff 100%);
      --card-shadow: 0 18px 60px rgba(8,24,64,0.08);
      --radius:14px;
      --max-width:1180px;
    }

    html,body{height:100%;margin:0;font-family:"Poppins",system-ui,-apple-system,Segoe UI,Roboto,Arial;color:#071022;background:var(--bg);}
    a{color:inherit;text-decoration:none}
    .container{max-width:var(--max-width);margin:0 auto;padding:0 20px}

    /* NAV (markup removed on this page; styles kept for reuse on home) */
    nav{position:fixed;left:0;right:0;top:12px;display:flex;align-items:center;justify-content:space-between;padding:12px 20px;z-index:1400}
    .logo{display:flex;gap:12px;align-items:center;background:linear-gradient(180deg,rgba(255,255,255,0.02),transparent);padding:6px 10px;border-radius:10px;box-shadow:0 6px 20px rgba(10,24,60,0.04)}
    .mark{width:44px;height:44px;border-radius:10px;background:linear-gradient(135deg,var(--primary),var(--primary-700));display:grid;place-items:center;color:#fff;font-weight:800}
    .nav-links{display:flex;gap:14px;align-items:center}
    .nav-links a{padding:8px 10px;border-radius:8px;font-weight:600;color:var(--muted)}
    .nav-links a:hover{background:rgba(0,0,0,0.03);color:var(--primary-700)}

    /* HERO */
    .hero{
      /* reduced top margin because navbar is removed on this page */
      margin-top:28px;
      background: linear-gradient(135deg, #0a3a6f 0%, #09325a 60%);
      color:#fff;
      padding:72px 20px;
      border-radius:18px;
      box-shadow: var(--card-shadow);
      margin-bottom:28px;
      position:relative;
      overflow:hidden;
    }
    .hero h1{font-size:2.4rem;margin:0 0 10px}
    .hero p{opacity:.95;max-width:68ch}

    /* page layout */
    .section{max-width:var(--max-width);margin:28px auto;padding:0 20px}
    .section .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:18px;margin-top:14px}
    .card{background:#fff;border-radius:12px;padding:14px;box-shadow:0 12px 30px rgba(10,20,50,0.06);transition:transform .2s;cursor:pointer;display:flex;flex-direction:column}
    .card:hover{transform:translateY(-8px)}
    .card h3{color:var(--primary-700);margin:8px 0 6px}
    .card p{color:var(--muted);font-size:.95rem;margin:0 0 8px}

    /* image inside cards */
    .card img{
      width:100%;
      height:150px;
      object-fit:cover;
      border-radius:8px;
      display:block;
      margin-bottom:10px;
    }

    /* detailed view */
    .detail {
      display:none;
      margin:30px auto 60px;
      max-width:1000px;
      background: linear-gradient(180deg,#fff,#fbfdff);
      border-radius:14px;
      padding:22px;
      box-shadow: var(--card-shadow);
      border:1px solid rgba(8,30,80,0.04);
    }
    .detail.show{display:block}
    .detail-header{display:flex;gap:18px;align-items:center;justify-content:space-between;flex-wrap:wrap}
    .detail-header h2{margin:0;color:var(--primary-700)}
    .detail-grid{display:grid;grid-template-columns:1fr 360px;gap:18px;margin-top:18px}
    @media(max-width:980px){ .detail-grid{grid-template-columns:1fr} }

    .detail-hero{border-radius:10px; overflow:hidden}
    .detail-hero img{width:100%;height:380px;object-fit:cover;display:block;border-radius:10px}
    .slideshow{position:relative;width:100%;height:380px;overflow:hidden;border-radius:10px}
    .slideshow img{width:100%;height:100%;object-fit:cover;position:absolute;top:0;left:0;opacity:0;transition:opacity .5s ease}
    .slideshow img.active{opacity:1}
    .slideshow-arrow{position:absolute;top:50%;transform:translateY(-50%);background:rgba(255,255,255,0.8);border:none;width:40px;height:40px;border-radius:50%;font-size:20px;color:#333;cursor:pointer;z-index:10;transition:background .3s}
    .slideshow-arrow:hover{background:#fff}
    .slideshow-arrow-left{left:10px}
    .slideshow-arrow-right{right:10px}



    /* right column widgets */
    .widget{background:#fff;border-radius:12px;padding:14px;box-shadow:0 10px 28px rgba(6,16,36,0.06);border:1px solid #eef6ff}
    .widget h4{margin:0 0 8px 0;color:var(--primary-700)}
    .map{height:260px;border-radius:8px;overflow:hidden}
    .weather{display:flex;gap:12px;align-items:center}
    .weather .temp{font-size:2rem;font-weight:800;color:#1f2937}
    .weather .meta{color:var(--muted)}

    /* hotels list */
    .hotels{display:grid;gap:12px}
    .hotel{display:flex;gap:12px;align-items:center;padding:10px;border-radius:10px;background:linear-gradient(180deg,#fff,#fbfdff);border:1px solid #f2f8ff}
    .hotel img{width:84px;height:64px;object-fit:cover;border-radius:8px}
    .hotel .info{flex:1}
    .hotel .info h5{margin:0;font-size:1rem;color:var(--primary-700)}
    .hotel .info p{margin:6px 0;color:var(--muted);font-size:.92rem}
    .hotel .cta{display:flex;flex-direction:column;gap:8px}
    .btn{padding:8px 12px;border-radius:10px;border:none;cursor:pointer;font-weight:700}
    .btn-primary{background:linear-gradient(90deg,var(--primary-700),#165fa8);color:#fff}
    .btn-ghost{background:transparent;border:1px solid rgba(7,18,40,0.06);color:var(--primary-700)}

    /* bottom actions */
    .actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
    .small{font-size:.9rem;color:var(--muted)}

    /* responsive tweaks */
    @media(max-width:640px){ .hero h1{font-size:1.6rem} .detail-hero img{height:220px} }

    /* subtle entrance */
    .reveal{opacity:0;transform:translateY(8px);transition:all .6s ease}
    .reveal.visible{opacity:1;transform:none}
    /* Back button (top-left) */
    .back-btn{
      position:fixed;
      left:18px;
      top:18px;
      z-index:1600;
      background:rgba(255,255,255,0.96);
      color:var(--primary-700);
      border-radius:10px;
      padding:8px 12px;
      box-shadow:0 8px 24px rgba(8,24,64,0.12);
      font-weight:700;
      text-decoration:none;
      display:inline-flex;
      align-items:center;
      gap:8px;
    }
    .back-btn:hover{transform:translateY(-2px)}

    /* rating stars */
    .rating-stars{display:flex;gap:4px;margin-top:8px}
    .rating-star{background:none;border:none;font-size:1.5rem;color:#ddd;cursor:pointer;padding:0;outline:none}
    .rating-star:hover,.rating-star.selected{color:#ffb400}
    .rating-star.unfilled{color:#ddd}

    /* transport options */
    .transport-options{display:flex;gap:10px;margin-bottom:10px}
    .transport-btn.active{background:var(--primary);color:#fff}
    .transport-details{margin-top:10px}
    .bus-list{display:grid;gap:12px}
    .bus-item{display:flex;gap:12px;align-items:center;padding:10px;border-radius:10px;background:linear-gradient(180deg,#fff,#fbfdff);border:1px solid #f2f8ff}
    .bus-item img{width:84px;height:64px;object-fit:cover;border-radius:8px}
    .bus-item .info{flex:1}
    .bus-item .info h5{margin:0;font-size:1rem;color:var(--primary-700)}
    .bus-item .info p{margin:6px 0;color:var(--muted);font-size:.92rem}
    .bus-item .cta{display:flex;flex-direction:column;gap:8px}
    .airlines-booking{background:#fff;border-radius:12px;padding:14px;margin-top:10px;border:1px solid #eef6ff}
    .airlines-booking h5{margin:0 0 10px;color:var(--primary-700)}
    .flight-option{display:flex;gap:12px;align-items:center;padding:10px;border-radius:10px;background:linear-gradient(180deg,#fff,#fbfdff);border:1px solid #f2f8ff;margin-bottom:10px}
    .flight-option img{width:84px;height:64px;object-fit:cover;border-radius:8px}
    .flight-option .info{flex:1}
    .flight-option .info h5{margin:0;font-size:1rem;color:var(--primary-700)}
    .flight-option .info p{margin:6px 0;color:var(--muted);font-size:.92rem}
    .flight-option .cta{display:flex;flex-direction:column;gap:8px}
  </style>
</head>
<body>

  <a href="gonepal.html" class="back-btn" aria-label="Go back to Home">← Go Back</a>

  <!-- NAV removed on this page (kept on home) -->

  <!-- HERO -->
  <section class="hero container">
    <h1>Top Destinations in Nepal</h1>
    <p>Explore Kathmandu Valley, Pokhara, Chitwan and Lumbini — maps, live weather, recommended hotels and directions all in one place.</p>
  </section>

  <main class="section" id="destinations">
    <h2 style="color:var(--primary-700)">Explore Destinations</h2>
    <p class="small">Click a card to view details, hotels, map, live weather and directions.</p>

    <div class="grid reveal" id="cards">
      <div class="card" data-id="kathmandu">
        <img src="ktm.jpg" alt="Kathmandu Valley">
        <h3>Kathmandu Valley</h3>
        <p>Historic temples, Durbar Squares, living heritage and Kathmandu's cultural heart.</p>
      </div>

      <div class="card" data-id="pokhara">
        <img src="pokhara.jpg" alt="Pokhara">
        <h3>Pokhara</h3>
        <p>Phewa Lake, Annapurna views, paragliding and peaceful lakeside vibes.</p>
      </div>

      <div class="card" data-id="chitwan">
        <img src="chitwan1.jpg" alt="Chitwan">
        <h3>Chitwan</h3>
        <p>Jungle safaris, wildlife encounters and rich Tharu culture.</p>
      </div>

      <div class="card" data-id="lumbini">
        <img src="lumbini.jpg" alt="Lumbini">
        <h3>Lumbini</h3>
        <p>Birthplace of Lord Buddha — sacred gardens, monasteries and pilgrimage.</p>
      </div>
    </div>

    <!-- DETAILS (one panel used for all destinations) -->
    <section class="detail reveal" id="detailPanel" aria-live="polite">
      <div class="detail-header">
        <h2 id="detailTitle">Destination</h2>
        <div style="display:flex;gap:10px;align-items:center">
          <button class="btn btn-ghost" id="backBtn">← Back</button>
          <div class="small" id="shortDesc">Overview</div>
        </div>
      </div>

      <div class="detail-grid" style="margin-top:16px">
        <div>
          <div class="detail-hero" id="heroImageWrap">
            <img id="heroImage" src="" alt="">
          </div>

          <div style="margin-top:16px" id="longDescContainer">
            <p id="longDesc" style="color:var(--muted)"></p>
          </div>

          <div style="margin-top:18px">
            <h4 style="margin:0 0 10px 0;color:var(--primary-700)">Hotels & Lodging</h4>
            <div class="hotels" id="hotelsList" aria-live="polite"></div>
          </div>

          <div style="margin-top:18px">
            <h4 style="margin:0 0 10px 0;color:var(--primary-700)">Transport</h4>
            <div class="transport-options" id="transportOptions">
              <button class="btn btn-ghost transport-btn" onclick="selectTransport('bus')">Bus</button>
              <button class="btn btn-ghost transport-btn" onclick="selectTransport('airlines')">Airlines</button>
            </div>
            <div class="transport-details" id="transportDetails" style="display:none;">
              <div id="busSection" style="display:none;">
                <h5 style="margin:10px 0;color:var(--primary-700)">Top Bus Companies</h5>
                <div class="bus-list" id="busList"></div>
              </div>
              <div id="airplaneSection" style="display:none;">
                <h5 style="margin:10px 0;color:var(--primary-700)">Airlines Tickets</h5>
                <div class="airlines-booking" id="airlinesBooking"></div>
              </div>
            </div>
          </div>
        </div>

        <aside>
          <div class="widget" style="margin-bottom:12px">
            <h4>Map</h4>
            <div id="map" class="map"></div>
            <div class="actions" style="margin-top:10px">
              <button class="btn btn-ghost" id="openMaps">Open in Google Maps</button>
              <button class="btn btn-ghost" id="directionsBtn">Directions</button>
            </div>
          </div>

          <div class="widget">
            <h4>Weather</h4>
            <div class="weather">
              <div class="temp" id="weatherTemp">—</div>
              <div class="meta" id="weatherDesc">Loading...</div>
            </div>
            <div class="small" id="weatherExtra"></div>
            <div style="margin-top:8px; font-size:0.9rem; color:var(--muted)">
              <div id="weatherFeels">Feels like: —</div>
              <div id="weatherHumidity">Humidity: —</div>
              <div id="weatherPressure">Pressure: —</div>
              <div id="weatherUV">UV Index: —</div>
            </div>
          </div>

          <div class="widget">
            <h4>Quick Info</h4>
            <div style="display:flex;flex-direction:column;gap:8px;margin-top:8px">
              <div><strong>Best time:</strong> <span id="bestTime">—</span></div>
              <div><strong>Popular activities:</strong> <span id="activities">—</span></div>
              <div><strong>Distance from Kathmandu:</strong> <span id="distance">—</span></div>
            </div>
          </div>

          <div class="widget">
            <h4>Rate this Destination</h4>
            <div class="rating-stars" id="destinationStars" role="radiogroup" aria-label="Rate destination">
              <button class="rating-star unfilled" data-value="1" aria-label="1 star">★</button>
              <button class="rating-star unfilled" data-value="2" aria-label="2 stars">★</button>
              <button class="rating-star unfilled" data-value="3" aria-label="3 stars">★</button>
              <button class="rating-star unfilled" data-value="4" aria-label="4 stars">★</button>
              <button class="rating-star unfilled" data-value="5" aria-label="5 stars">★</button>
            </div>
            <div style="margin-top:8px; font-size:0.9rem; color:var(--muted)">
              <span id="destinationAvg">—</span> (<span id="destinationCount">0</span> ratings)
            </div>
          </div>
        </aside>
      </div>
    </section>

  </main>

  <footer style="text-align:center;padding:36px 20px;background:linear-gradient(90deg,var(--primary),var(--primary-700));color:#fff;margin-top:40px">
    <div class="container">
      <strong>GoNepal</strong> — Explore Nepal • © <span id="year"></span>
    </div>
  </footer>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    // Data for destinations (images should exist or be replaced)
    const DESTINATIONS = {
      kathmandu: {
        id: 'kathmandu',
        title: 'Kathmandu Valley',
        short: 'Historic temples, Durbar Squares and cultural heritage in the capital valley.',
        long: 'Kathmandu Valley hosts a remarkable concentration of temples, palaces and living cultural traditions. Explore UNESCO-listed Durbar Squares in Kathmandu, Patan and Bhaktapur, visit Swayambhunath and Boudhanath stupas, and experience bustling markets and traditional Newari architecture.',
        coords: [27.712,85.3240],
        images: ['ktmi.jpg', 'ktm.jpg'],
        bestTime: 'Sept–Nov & Mar–May',
        activities: 'Heritage walks, temples, markets',
        distance: 'N/A'
      },
      pokhara: {
        id: 'pokhara',
        title: 'Pokhara',
        short: 'Lakeside town with Annapurna panorama and adventure sports.',
        long: 'Pokhara is Nepal’s adventure and leisure hub — boat on Phewa Lake, paraglide over the valley, or take short day-treks. It offers spectacular sunrise views of Annapurna and Machapuchare and a relaxed lakeside atmosphere.',
        coords: [28.2096,83.9856],
        images: ['pokharanew.jpg', 'pokhara.jpg'],
        bestTime: 'Sept–Nov & Mar–May',
        activities: 'Boating, paragliding, trekking',
        distance: '~200 km from Kathmandu'
      },
      chitwan: {
        id: 'chitwan',
        title: 'Chitwan National Park',
        short: 'Wildlife safaris, one-horned rhino and Tharu culture.',
        long: 'Chitwan is Nepal’s premier national park offering jeep and canoe safaris, guided jungle walks and cultural visits to Tharu villages. This lowland wetland environment is great for wildlife viewing and conservation-focused tourism.',
        coords: [27.5291,84.3542],
        images: ['chitwani.jpg', 'chitwan1.jpg'],
        bestTime: 'Oct–March',
        activities: 'Wildlife safari, birdwatching, canoeing',
        distance: '~150 km from Kathmandu'
      },
      lumbini: {
        id: 'lumbini',
        title: 'Lumbini',
        short: 'Birthplace of Lord Buddha — sacred gardens and monasteries.',
        long: 'Lumbini is a UNESCO World Heritage site and pilgrimage destination. Visit the Maya Devi Temple, international monasteries and meditation gardens. It’s a peaceful place for reflection and cultural learning.',
        coords: [27.4845,83.2759],
        images: ['lumbinii.jpg', 'lumbini.jpg'],
        bestTime: 'Oct–Mar',
        activities: 'Pilgrimage, cultural tours',
        distance: '~260 km from Kathmandu'
      }
    };

    // Hotels mock data
    const HOTELS = {
      kathmandu: [
        {name:'Kathmandu Heritage Hotel',price:'$45/night',rating:4.2,img:'ktmheritage.jpg',link:'#'},
        {name:'Valley Boutique Hotel',price:'$75/night',rating:4.6,img:'valley.jpg',link:'#'},
        {name:'Durbar Suites',price:'$120/night',rating:4.8,img:'durbar.jpg',link:'#'}
      ],
      pokhara: [
        {name:'Lakeside Retreat',price:'$60/night',rating:4.5,img:'hotel4.jpg',link:'#'},
        {name:'Annapurna View Lodge',price:'$90/night',rating:4.7,img:'hotel5.jpg',link:'#'},
        {name:'Phewa Grand',price:'$140/night',rating:4.9,img:'hotel6.jpg',link:'#'}
      ],
      chitwan: [
        {name:'Jungle Safari Lodge',price:'$55/night',rating:4.4,img:'hotel7.jpg',link:'#'},
        {name:'Tharu Cultural Resort',price:'$80/night',rating:4.6,img:'hotel8.jpg',link:'#'},
        {name:'Riverfront Camp',price:'$65/night',rating:4.5,img:'hotel9.jpg',link:'#'}
      ],
      lumbini: [
        {name:'Lumbini Garden Hotel',price:'$48/night',rating:4.3,img:'hotel10.jpg',link:'#'},
        {name:'Pilgrim Comfort Inn',price:'$70/night',rating:4.5,img:'hotel11.jpg',link:'#'},
        {name:'Meditation Retreat Resort',price:'$120/night',rating:4.8,img:'hotel12.jpg',link:'#'}
      ]
    };

    // Preload images (best-effort)
    Object.values(DESTINATIONS).forEach(d => { d.images.forEach(img => { const i=new Image(); i.src=img; }); });

    // keep leaflet map instances
    const MAPS = {};

    // utility - show detail
    const detailPanel = document.getElementById('detailPanel');
    const detailTitle = document.getElementById('detailTitle');
    const shortDesc = document.getElementById('shortDesc');
    const heroImage = document.getElementById('heroImage');
    const longDesc = document.getElementById('longDesc');
    const hotelsList = document.getElementById('hotelsList');
    const weatherTemp = document.getElementById('weatherTemp');
    const weatherDesc = document.getElementById('weatherDesc');
    const weatherExtra = document.getElementById('weatherExtra');
    const bestTimeEl = document.getElementById('bestTime');
    const activitiesEl = document.getElementById('activities');
    const distanceEl = document.getElementById('distance');
    const openMapsBtn = document.getElementById('openMaps');
    const directionsBtn = document.getElementById('directionsBtn');
    let currentDestination = null;

    // initial reveal
    document.addEventListener('DOMContentLoaded', () => {
      setTimeout(()=>document.querySelectorAll('.reveal').forEach(el=>el.classList.add('visible')),60);
      document.getElementById('year').innerText = new Date().getFullYear();

      // cards click
      document.querySelectorAll('#cards .card').forEach(c=>{
        c.addEventListener('click', () => openDetail(c.dataset.id));
      });

      document.getElementById('backBtn').addEventListener('click', () => {
        detailPanel.classList.remove('show');
        window.scrollTo({top:document.getElementById('destinations').offsetTop - 20, behavior:'smooth'});
      });

    });

    async function openDetail(id){
      const d = DESTINATIONS[id];
      if(!d) return;
      currentDestination = d;
      detailTitle.innerText = d.title;
      shortDesc.innerText = d.short;

      // Handle hero image or slideshow
      const heroWrap = document.getElementById('heroImageWrap');
      heroWrap.innerHTML = ''; // clear previous content

      if (d.images && d.images.length > 1) {
        heroWrap.classList.add('slideshow');

        // Create images
        d.images.forEach((imgSrc, index) => {
          const img = document.createElement('img');
          img.src = imgSrc;
          img.alt = d.title;
          if (index === 0) img.classList.add('active');
          heroWrap.appendChild(img);
        });

        // Create navigation dots
        const nav = document.createElement('div');
        nav.className = 'slideshow-nav';
        d.images.forEach((_, index) => {
          const dot = document.createElement('button');
          dot.className = 'slideshow-dot';
          if (index === 0) dot.classList.add('active');
          dot.addEventListener('click', () => showSlide(index));
          nav.appendChild(dot);
        });
        heroWrap.appendChild(nav);

        // Create arrows
        const leftArrow = document.createElement('button');
        leftArrow.className = 'slideshow-arrow slideshow-arrow-left';
        leftArrow.innerHTML = '‹';
        leftArrow.addEventListener('click', () => {
          clearInterval(autoSlideInterval);
          changeSlide(-1);
          startAutoSlide();
        });
        heroWrap.appendChild(leftArrow);

        const rightArrow = document.createElement('button');
        rightArrow.className = 'slideshow-arrow slideshow-arrow-right';
        rightArrow.innerHTML = '›';
        rightArrow.addEventListener('click', () => {
          clearInterval(autoSlideInterval);
          changeSlide(1);
          startAutoSlide();
        });
        heroWrap.appendChild(rightArrow);

        // Slideshow variables and functions
        let currentSlide = 0;
        let autoSlideInterval;
        function showSlide(index) {
          const imgs = heroWrap.querySelectorAll('img');
          const dots = heroWrap.querySelectorAll('.slideshow-dot');
          imgs.forEach(img => img.classList.remove('active'));
          dots.forEach(dot => dot.classList.remove('active'));
          imgs[index].classList.add('active');
          dots[index].classList.add('active');
          currentSlide = index;
        }
        function changeSlide(direction) {
          currentSlide = (currentSlide + direction + d.images.length) % d.images.length;
          showSlide(currentSlide);
        }
        function startAutoSlide() {
          setTimeout(() => {
            autoSlideInterval = setInterval(() => changeSlide(1), 3000);
          }, 3000);
        }
        startAutoSlide();
      } else {
        heroWrap.classList.remove('slideshow');
        const img = document.createElement('img');
        img.src = d.images ? d.images[0] : '';
        img.alt = d.title;
        heroWrap.appendChild(img);
      }

      longDesc.innerText = d.long;
      bestTimeEl.innerText = d.bestTime;
      activitiesEl.innerText = d.activities;
      distanceEl.innerText = d.distance;
      // fill hotels
      hotelsList.innerHTML = '';
      const sortedHotels = [...(HOTELS[id]||[])].sort((a, b) => b.rating - a.rating);
      sortedHotels.forEach((h, i) => {
        const node = document.createElement('div');
        node.className = 'hotel';
        node.innerHTML = `
          <img src="${h.img}" alt="${h.name}">
          <div class="info">
            <h5>${h.name}</h5>
            <p>${h.price} • ${h.rating} ★</p>
            <div class="rating-stars" id="hotelStars_${i}" role="radiogroup" aria-label="Rate ${h.name}">
              <button class="rating-star unfilled" data-value="1" aria-label="1 star">★</button>
              <button class="rating-star unfilled" data-value="2" aria-label="2 stars">★</button>
              <button class="rating-star unfilled" data-value="3" aria-label="3 stars">★</button>
              <button class="rating-star unfilled" data-value="4" aria-label="4 stars">★</button>
              <button class="rating-star unfilled" data-value="5" aria-label="5 stars">★</button>
            </div>
            <div style="margin-top:4px; font-size:0.8rem; color:var(--muted)">
              <span id="hotelAvg_${i}">—</span> (<span id="hotelCount_${i}">0</span> ratings)
            </div>
          </div>
          <div class="cta">
            <button class="btn btn-ghost" onclick="viewHotel('${id}','${h.name.replace(/'/g,"\\'")}')">View</button>
            <button class="btn btn-primary" onclick="bookHotel('${h.name.replace(/'/g,"\\'")}')">Book</button>
          </div>
        `;
        hotelsList.appendChild(node);
      });
      // Initialize hotel ratings
      (HOTELS[id]||[]).forEach((h, i) => {
        initHotelRating(i, currentDestination.id, h.name);
      });

      detailPanel.classList.add('show');
      // init map
      initMap('map', d.coords, d.title);
      // fetch weather
      fetchWeather(d.coords);

      // setup external links
      openMapsBtn.onclick = () => {
        const url = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(d.title)}&query_place_id=`;
        window.open(url, '_blank');
      };
      directionsBtn.onclick = () => {
        const url = `https://www.google.com/maps/dir/?api=1&destination=${encodeURIComponent(d.title)}`;
        window.open(url, '_blank');
      };

      // scroll into view
      setTimeout(()=> detailPanel.scrollIntoView({behavior:'smooth', block:'start'}), 80);
    }

    function viewHotel(dest, hotelName){
      alert(`${hotelName} — more details page coming soon.`);
    }
    function bookHotel(name){
      alert(`Booking flow for ${name} — demo only.`);
    }

    // Map creation / reuse
    function initMap(containerId, coords, title){
      // containerId may be 'map' (single right widget)
      const el = document.getElementById(containerId);
      if(!el) return;
      // remove previous map if exists
      if(MAPS[containerId]){
        try{ MAPS[containerId].setView(coords, 12); MAPS[containerId + '_marker'].setLatLng(coords); } catch(e){}
        return;
      }
      const map = L.map(containerId, {zoomControl:false}).setView(coords, 12);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {maxZoom:19}).addTo(map);
      const marker = L.marker(coords).addTo(map).bindPopup(title).openPopup();
      MAPS[containerId] = map;
      MAPS[containerId + '_marker'] = marker;
      // small touch: resize after short delay
      setTimeout(()=> map.invalidateSize(), 300);
    }

    // Fetch weather data from WeatherAPI
    async function fetchWeather(coords){
      try{
        const [lat, lon] = coords;
        weatherTemp.innerText = '...';
        weatherDesc.innerText = 'Loading...';
        weatherExtra.innerText = '';
        document.getElementById('weatherFeels').innerText = 'Feels like: —';
        document.getElementById('weatherHumidity').innerText = 'Humidity: —';
        document.getElementById('weatherPressure').innerText = 'Pressure: —';
        document.getElementById('weatherUV').innerText = 'UV Index: —';

        const apiKey = '91990f72982a41738b293259250412';
        const response = await fetch(`https://api.weatherapi.com/v1/current.json?key=${apiKey}&q=${lat},${lon}`);
        if (!response.ok) throw new Error('Weather API error');
        const data = await response.json();

        // Populate weather data
        weatherTemp.innerText = `${data.current.temp_c}°C`;
        weatherDesc.innerText = data.current.condition.text;
        weatherExtra.innerText = `Wind ${data.current.wind_kph} km/h • Updated`;
        document.getElementById('weatherFeels').innerText = `Feels like: ${data.current.feelslike_c}°C`;
        document.getElementById('weatherHumidity').innerText = `Humidity: ${data.current.humidity}%`;
        document.getElementById('weatherPressure').innerText = `Pressure: ${data.current.pressure_mb} hPa`;
        document.getElementById('weatherUV').innerText = `UV Index: ${data.current.uv}`;
      }catch(err){
        weatherTemp.innerText = '—';
        weatherDesc.innerText = 'Weather unavailable';
        weatherExtra.innerText = '';
        document.getElementById('weatherFeels').innerText = 'Feels like: —';
        document.getElementById('weatherHumidity').innerText = 'Humidity: —';
        document.getElementById('weatherPressure').innerText = 'Pressure: —';
        document.getElementById('weatherUV').innerText = 'UV Index: —';
        console.warn(err);
      }
    }

    // small guard: if map container removed, create dynamic
    window.addEventListener('resize', ()=> {
      if(MAPS['map']) MAPS['map'].invalidateSize && MAPS['map'].invalidateSize();
    });

    // helper: create small directions link for each hotel (optional)
    function hotelDirections(name){
      const url = `https://www.google.com/maps/dir/?api=1&destination=${encodeURIComponent(name)}`;
      window.open(url,'_blank');
    }

    // Rating functionality
    function loadDestinationRatings(destinationId) {
      const ratings = JSON.parse(localStorage.getItem('destinationRatings') || '{}');
      return ratings[destinationId] || [];
    }

    function saveDestinationRating(destinationId, rating) {
      const ratings = JSON.parse(localStorage.getItem('destinationRatings') || '{}');
      if (!ratings[destinationId]) ratings[destinationId] = [];
      ratings[destinationId].push(rating);
      localStorage.setItem('destinationRatings', JSON.stringify(ratings));
    }

    function updateDestinationRatingDisplay(destinationId) {
      const ratings = loadDestinationRatings(destinationId);
      const avgEl = document.getElementById('destinationAvg');
      const countEl = document.getElementById('destinationCount');
      const stars = document.querySelectorAll('#destinationStars .rating-star');

      if (ratings.length > 0) {
        const avg = ratings.reduce((a, b) => a + b, 0) / ratings.length;
        avgEl.textContent = avg.toFixed(1);
        countEl.textContent = ratings.length;
      } else {
        avgEl.textContent = '—';
        countEl.textContent = '0';
      }

      // Reset stars
      stars.forEach(star => star.classList.remove('selected'));
    }

    function initDestinationRating() {
      const stars = document.querySelectorAll('#destinationStars .rating-star');
      stars.forEach(star => {
        star.addEventListener('click', () => {
          const rating = parseInt(star.dataset.value);
          if (currentDestination) {
            saveDestinationRating(currentDestination.id, rating);
            updateDestinationRatingDisplay(currentDestination.id);
          }
        });

        star.addEventListener('mouseenter', () => {
          const value = parseInt(star.dataset.value);
          stars.forEach((s, i) => {
            if (i < value) s.classList.add('selected');
            else s.classList.remove('selected');
          });
        });

        star.addEventListener('mouseleave', () => {
          stars.forEach(s => s.classList.remove('selected'));
        });
      });
    }

    // Initialize rating on page load
    document.addEventListener('DOMContentLoaded', () => {
      initDestinationRating();
    });

    // Hotel rating functionality
    function loadHotelRatings(destinationId, hotelName) {
      const key = `hotel_rating_${destinationId}_${hotelName}`;
      let stored = null;
      try { stored = JSON.parse(localStorage.getItem(key) || 'null'); } catch(e){ stored = null; }
      let ratingData = stored && typeof stored.sum === 'number' && typeof stored.count === 'number' ? stored : { sum:0, count:0 };
      return ratingData;
    }

    function updateHotelRatingDisplay(index, destinationId, hotelName) {
      const data = loadHotelRatings(destinationId, hotelName);
      const avgEl = document.getElementById(`hotelAvg_${index}`);
      const countEl = document.getElementById(`hotelCount_${index}`);
      if(!avgEl || !countEl) return;
      if(data.count === 0){
        if(avgEl) avgEl.textContent = '—';
        countEl.textContent = '0';
      } else {
        const avg = data.sum / data.count;
        if(avgEl) avgEl.textContent = avg.toFixed(1);
        countEl.textContent = data.count;
      }
    }

    function initHotelRating(index, destinationId, hotelName) {
      const starEls = document.querySelectorAll(`#hotelStars_${index} .rating-star`);
      let selected = null;
      let currentHotel = hotelName;

      function loadRatings(){
        const data = loadHotelRatings(destinationId, currentHotel);
        updateHotelRatingDisplay(index, destinationId, currentHotel);
        return data;
      }

      // star interactions
      starEls.forEach(st => {
        st.setAttribute('tabindex','0');
        st.addEventListener('mouseenter', () => {
          const v = Number(st.dataset.value);
          starEls.forEach(s => s.classList.toggle('hover', Number(s.dataset.value) <= v));
        });
        st.addEventListener('mouseleave', () => starEls.forEach(s => s.classList.remove('hover')));
        st.addEventListener('click', () => {
          if(localStorage.getItem('loggedIn') !== 'true'){
            showToast('Please login to rate this hotel');
            return;
          }
          selected = Number(st.dataset.value);
          starEls.forEach(s => {
            const val = Number(s.dataset.value);
            if(val <= selected){
              s.classList.add('selected');
              s.classList.remove('unfilled');
            } else {
              s.classList.remove('selected');
              s.classList.add('unfilled');
            }
          });
          // save rating
          const key = `hotel_rating_${destinationId}_${currentHotel}`;
          let data = loadRatings();
          data.sum = (data.sum || 0) + selected;
          data.count = (data.count || 0) + 1;
          localStorage.setItem(key, JSON.stringify(data));
          updateHotelRatingDisplay(index, destinationId, currentHotel);
          showToast('Thanks for rating!');
        });
        st.addEventListener('keydown', (e) => {
          const curr = Number(document.activeElement.dataset.value);
          if(e.key === 'ArrowRight' || e.key === 'ArrowUp'){ e.preventDefault(); const next = Math.min(5, curr+1); document.querySelector(`#hotelStars_${index} .rating-star[data-value="${next}"]`)?.focus(); }
          if(e.key === 'ArrowLeft' || e.key === 'ArrowDown'){ e.preventDefault(); const prev = Math.max(1, curr-1); document.querySelector(`#hotelStars_${index} .rating-star[data-value="${prev}"]`)?.focus(); }
          if(e.key === 'Enter' || e.key === ' '){ e.preventDefault(); st.click(); }
        });
      });

      // load initial ratings
      loadRatings();
    }

    function showToast(msg){
      const el = document.createElement('div');
      el.style.position='fixed';
      el.style.bottom='20px';
      el.style.left='50%';
      el.style.transform='translateX(-50%)';
      el.style.background='rgba(7,18,40,0.9)';
      el.style.color='#fff';
      el.style.padding='12px 18px';
      el.style.borderRadius='10px';
      el.style.boxShadow='0 8px 30px rgba(8,24,64,0.4)';
      el.style.zIndex=1600;
      el.innerText = msg;
      document.body.appendChild(el);
      setTimeout(()=>{ el.style.opacity='0'; setTimeout(()=>el.remove(),300) }, 2200);
    }

    // Bus rating functionality
    function loadBusRatings(busName) {
      const key = `bus_rating_${busName}`;
      let stored = null;
      try { stored = JSON.parse(localStorage.getItem(key) || 'null'); } catch(e){ stored = null; }
      let ratingData = stored && typeof stored.sum === 'number' && typeof stored.count === 'number' ? stored : { sum:0, count:0 };
      return ratingData;
    }

    function updateBusRatingDisplay(index, busName) {
      const data = loadBusRatings(busName);
      const avgEl = document.getElementById(`busAvg_${index}`);
      const countEl = document.getElementById(`busCount_${index}`);
      if(!avgEl || !countEl) return;
      if(data.count === 0){
        if(avgEl) avgEl.textContent = '—';
        countEl.textContent = '0';
      } else {
        const avg = data.sum / data.count;
        if(avgEl) avgEl.textContent = avg.toFixed(1);
        countEl.textContent = data.count;
      }
    }

    function initBusRating(index, busName) {
      const starEls = document.querySelectorAll(`#busStars_${index} .rating-star`);
      let selected = null;
      let currentBus = busName;

      function loadRatings(){
        const data = loadBusRatings(currentBus);
        updateBusRatingDisplay(index, currentBus);
        return data;
      }

      // star interactions
      starEls.forEach(st => {
        st.setAttribute('tabindex','0');
        st.addEventListener('mouseenter', () => {
          const v = Number(st.dataset.value);
          starEls.forEach(s => s.classList.toggle('hover', Number(s.dataset.value) <= v));
        });
        st.addEventListener('mouseleave', () => starEls.forEach(s => s.classList.remove('hover')));
        st.addEventListener('click', () => {
          if(localStorage.getItem('loggedIn') !== 'true'){
            showToast('Please login to rate this bus company');
            return;
          }
          selected = Number(st.dataset.value);
          starEls.forEach(s => {
            const val = Number(s.dataset.value);
            if(val <= selected){
              s.classList.add('selected');
              s.classList.remove('unfilled');
            } else {
              s.classList.remove('selected');
              s.classList.add('unfilled');
            }
          });
          // save rating
          const key = `bus_rating_${currentBus}`;
          let data = loadRatings();
          data.sum = (data.sum || 0) + selected;
          data.count = (data.count || 0) + 1;
          localStorage.setItem(key, JSON.stringify(data));
          updateBusRatingDisplay(index, currentBus);
          showToast('Thanks for rating!');
        });
        st.addEventListener('keydown', (e) => {
          const curr = Number(document.activeElement.dataset.value);
          if(e.key === 'ArrowRight' || e.key === 'ArrowUp'){ e.preventDefault(); const next = Math.min(5, curr+1); document.querySelector(`#busStars_${index} .rating-star[data-value="${next}"]`)?.focus(); }
          if(e.key === 'ArrowLeft' || e.key === 'ArrowDown'){ e.preventDefault(); const prev = Math.max(1, curr-1); document.querySelector(`#busStars_${index} .rating-star[data-value="${prev}"]`)?.focus(); }
          if(e.key === 'Enter' || e.key === ' '){ e.preventDefault(); st.click(); }
        });
      });

    // load initial ratings
      loadRatings();
    }

    // Airline rating functionality
    function loadAirlineRatings(airlineName) {
      const key = `airline_rating_${airlineName}`;
      let stored = null;
      try { stored = JSON.parse(localStorage.getItem(key) || 'null'); } catch(e){ stored = null; }
      let ratingData = stored && typeof stored.sum === 'number' && typeof stored.count === 'number' ? stored : { sum:0, count:0 };
      return ratingData;
    }

    function updateAirlineRatingDisplay(index, airlineName) {
      const data = loadAirlineRatings(airlineName);
      const avgEl = document.getElementById(`airlineAvg_${index}`);
      const countEl = document.getElementById(`airlineCount_${index}`);
      if(!avgEl || !countEl) return;
      if(data.count === 0){
        if(avgEl) avgEl.textContent = '—';
        countEl.textContent = '0';
      } else {
        const avg = data.sum / data.count;
        if(avgEl) avgEl.textContent = avg.toFixed(1);
        countEl.textContent = data.count;
      }
    }

    function initAirlineRating(index, airlineName) {
      const starEls = document.querySelectorAll(`#airlineStars_${index} .rating-star`);
      let selected = null;
      let currentAirline = airlineName;

      function loadRatings(){
        const data = loadAirlineRatings(currentAirline);
        updateAirlineRatingDisplay(index, currentAirline);
        return data;
      }

      // star interactions
      starEls.forEach(st => {
        st.setAttribute('tabindex','0');
        st.addEventListener('mouseenter', () => {
          const v = Number(st.dataset.value);
          starEls.forEach(s => s.classList.toggle('hover', Number(s.dataset.value) <= v));
        });
        st.addEventListener('mouseleave', () => starEls.forEach(s => s.classList.remove('hover')));
        st.addEventListener('click', () => {
          if(localStorage.getItem('loggedIn') !== 'true'){
            showToast('Please login to rate this airline');
            return;
          }
          selected = Number(st.dataset.value);
          starEls.forEach(s => {
            const val = Number(s.dataset.value);
            if(val <= selected){
              s.classList.add('selected');
              s.classList.remove('unfilled');
            } else {
              s.classList.remove('selected');
              s.classList.add('unfilled');
            }
          });
          // save rating
          const key = `airline_rating_${currentAirline}`;
          let data = loadRatings();
          data.sum = (data.sum || 0) + selected;
          data.count = (data.count || 0) + 1;
          localStorage.setItem(key, JSON.stringify(data));
          updateAirlineRatingDisplay(index, currentAirline);
          showToast('Thanks for rating!');
        });
        st.addEventListener('keydown', (e) => {
          const curr = Number(document.activeElement.dataset.value);
          if(e.key === 'ArrowRight' || e.key === 'ArrowUp'){ e.preventDefault(); const next = Math.min(5, curr+1); document.querySelector(`#airlineStars_${index} .rating-star[data-value="${next}"]`)?.focus(); }
          if(e.key === 'ArrowLeft' || e.key === 'ArrowDown'){ e.preventDefault(); const prev = Math.max(1, curr-1); document.querySelector(`#airlineStars_${index} .rating-star[data-value="${prev}"]`)?.focus(); }
          if(e.key === 'Enter' || e.key === ' '){ e.preventDefault(); st.click(); }
        });
      });

      // load initial ratings
      loadRatings();
    }

    // Update rating display when opening detail
    const originalOpenDetail = openDetail;
    openDetail = function(id) {
      originalOpenDetail(id);
      updateDestinationRatingDisplay(id);
      // Reset transport selection
      document.querySelectorAll('.transport-btn').forEach(btn => btn.classList.remove('active'));
      document.getElementById('transportDetails').style.display = 'none';
      document.getElementById('busSection').style.display = 'none';
      document.getElementById('airplaneSection').style.display = 'none';
    };

    // Transport functionality
    const BUS_COMPANIES = [
      {name: 'Greenline Travels', price: 'NPR 800', rating: 4.5, img: 'bus1.jpg'},
      {name: 'Sajha Yatayat', price: 'NPR 750', rating: 4.3, img: 'bus2.jpg'},
      {name: 'Nepal Yatayat', price: 'NPR 700', rating: 4.2, img: 'bus3.jpg'}
    ];

    const FLIGHTS = [
      {name: 'Buddha Air', price: 'NPR 4500', rating: 4.6, img: 'flight1.jpg'},
      {name: 'Yet Airways', price: 'NPR 4200', rating: 4.4, img: 'flight2.jpg'},
      {name: 'Shree Airlines', price: 'NPR 4800', rating: 4.5, img: 'flight3.jpg'}
    ];

    function selectTransport(type) {
      // Update button states
      document.querySelectorAll('.transport-btn').forEach(btn => btn.classList.remove('active'));
      event.target.classList.add('active');

      // Show transport details
      document.getElementById('transportDetails').style.display = 'block';

      if (type === 'bus') {
        document.getElementById('busSection').style.display = 'block';
        document.getElementById('airplaneSection').style.display = 'none';

        // Sort buses by rating (highest first)
        const sortedBuses = [...BUS_COMPANIES].sort((a, b) => b.rating - a.rating);

        // Populate bus list
        const busList = document.getElementById('busList');
        busList.innerHTML = '';
        sortedBuses.forEach((bus, i) => {
          const node = document.createElement('div');
          node.className = 'bus-item';
          node.innerHTML = `
            <img src="${bus.img}" alt="${bus.name}">
            <div class="info">
              <h5>${bus.name}</h5>
              <p>${bus.price} • ${bus.rating} ★</p>
              <div class="rating-stars" id="busStars_${i}" role="radiogroup" aria-label="Rate ${bus.name}">
                <button class="rating-star unfilled" data-value="1" aria-label="1 star">★</button>
                <button class="rating-star unfilled" data-value="2" aria-label="2 stars">★</button>
                <button class="rating-star unfilled" data-value="3" aria-label="3 stars">★</button>
                <button class="rating-star unfilled" data-value="4" aria-label="4 stars">★</button>
                <button class="rating-star unfilled" data-value="5" aria-label="5 stars">★</button>
              </div>
              <div style="margin-top:4px; font-size:0.8rem; color:var(--muted)">
                <span id="busAvg_${i}">—</span> (<span id="busCount_${i}">0</span> ratings)
              </div>
            </div>
            <div class="cta">
              <button class="btn btn-ghost" onclick="viewBus('${bus.name}')">View</button>
              <button class="btn btn-primary" onclick="bookBus('${bus.name}')">Book</button>
            </div>
          `;
          busList.appendChild(node);
        });
        // Initialize bus ratings
        BUS_COMPANIES.forEach((bus, i) => {
          initBusRating(i, bus.name);
        });
      } else if (type === 'airlines') {
        document.getElementById('busSection').style.display = 'none';
        document.getElementById('airplaneSection').style.display = 'block';

        // Sort flights by rating (highest first)
        const sortedFlights = [...FLIGHTS].sort((a, b) => b.rating - a.rating);

        // Populate airlines booking
        const airlinesBooking = document.getElementById('airlinesBooking');
        airlinesBooking.innerHTML = '';
        sortedFlights.forEach((flight, i) => {
          const node = document.createElement('div');
          node.className = 'flight-option';
          node.innerHTML = `
            <img src="${flight.img}" alt="${flight.name}">
            <div class="info">
              <h5>${flight.name}</h5>
              <p>${flight.price} • ${flight.rating} ★</p>
              <div class="rating-stars" id="airlineStars_${i}" role="radiogroup" aria-label="Rate ${flight.name}">
                <button class="rating-star unfilled" data-value="1" aria-label="1 star">★</button>
                <button class="rating-star unfilled" data-value="2" aria-label="2 stars">★</button>
                <button class="rating-star unfilled" data-value="3" aria-label="3 stars">★</button>
                <button class="rating-star unfilled" data-value="4" aria-label="4 stars">★</button>
                <button class="rating-star unfilled" data-value="5" aria-label="5 stars">★</button>
              </div>
              <div style="margin-top:4px; font-size:0.8rem; color:var(--muted)">
                <span id="airlineAvg_${i}">—</span> (<span id="airlineCount_${i}">0</span> ratings)
              </div>
            </div>
            <div class="cta">
              <button class="btn btn-ghost" onclick="viewFlight('${flight.name}')">View</button>
              <button class="btn btn-primary" onclick="bookFlight('${flight.name}')">Book</button>
            </div>
          `;
          airlinesBooking.appendChild(node);
        });
        // Initialize airline ratings
        FLIGHTS.forEach((flight, i) => {
          initAirlineRating(i, flight.name);
        });
      }
    }

    function viewBus(name) {
      alert(`${name} — more details page coming soon.`);
    }

    function bookBus(name) {
      alert(`Booking flow for ${name} — demo only.`);
    }

    function viewFlight(name) {
      alert(`${name} — more details page coming soon.`);
    }

    function bookFlight(name) {
      alert(`Booking flow for ${name} — demo only.`);
    }

  </script>
</body>
</html>